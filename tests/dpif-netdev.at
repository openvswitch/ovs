AT_BANNER([dpif-netdev])

m4_divert_push([PREPARE_TESTS])
[
# Strips out uninteresting parts of flow output, as well as parts
# that vary from one run to another (e.g., timing and bond actions).
strip_timers () {
    sed '
    s/duration:[0-9\.][0-9\.]*/duration:0.0/
    s/used:[0-9\.][0-9\.]*/used:0.0/
'
}

strip_xout () {
    sed '
    s/mega_ufid:[-0-9a-f]* //
    s/ufid:[-0-9a-f]* //
    s/used:[0-9\.][0-9\.]*/used:0.0/
    s/actions:.*/actions: <del>/
    s/packets:[0-9]*/packets:0/
    s/bytes:[0-9]*/bytes:0/
' | sort
}

strip_xout_keep_actions () {
    sed '
    s/mega_ufid:[-0-9a-f]* //
    s/ufid:[-0-9a-f]* //
    s/used:[0-9\.][0-9\.]*/used:0.0/
    s/packets:[0-9]*/packets:0/
    s/bytes:[0-9]*/bytes:0/
' | sort
}

filter_flow_install () {
    grep 'flow_add' | sed 's/.*flow_add: //' | sort | uniq
}

filter_hw_flow_install () {
    grep 'netdev_dummy.*flow put\[create\]' | sed 's/.*|DBG|//' | sort | uniq
}

filter_hw_flow_del () {
    grep 'netdev_dummy.*flow del' | sed 's/.*|DBG|//' | sort | uniq
}

filter_hw_packet_netdev_dummy () {
    grep 'netdev_dummy.*: packet:.*with mark' | sed 's/.*|DBG|//' | sort | uniq
}

filter_flow_dump () {
    grep 'flow_dump ' | sed '
        s/.*flow_dump //
        s/used:[0-9\.][0-9\.]*/used:0.0/
    ' | sort | uniq
}

strip_metadata () {
    sed 's/metadata=0x[0-9a-f]*/metadata=0x0/'
}
]
m4_divert_pop([PREPARE_TESTS])

AT_SETUP([dpif-netdev - netdev-dummy/receive])
# Create br0 with interfaces p0
OVS_VSWITCHD_START([add-port br0 p1 -- set interface p1 type=dummy ofport_request=1 -- ])
AT_CHECK([ovs-appctl vlog/set dpif:dbg dpif_netdev:dbg])

AT_CHECK([ovs-ofctl add-flow br0 action=normal])
ovs-appctl time/stop
ovs-appctl time/warp 5000
AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),eth(src=50:54:00:00:00:01,dst=50:54:00:00:02:00),eth_type(0x0800),ipv4(src=10.0.0.1,dst=10.0.0.2,proto=6,tos=0,ttl=64,frag=no),tcp(src=8,dst=9),tcp_flags(ack)'])
   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:01,dst=50:54:00:00:02:00),eth_type(0x0800),ipv4(src=10.0.0.1,dst=10.0.0.2,proto=6,tos=0,ttl=64,frag=no),tcp(src=8,dst=9),tcp_flags(ack)
])

AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),eth(src=50:54:00:00:00:05,dst=50:54:00:00:06:00),eth_type(0x0800),ipv4(src=10.0.0.5,dst=10.0.0.6,proto=6,tos=0,ttl=64,frag=no),tcp(src=8,dst=9),tcp_flags(ack)' --len 1024])
   OVS_WAIT_UNTIL([test `grep -c "miss upcall" ovs-vswitchd.log` -ge 2])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:05,dst=50:54:00:00:06:00),eth_type(0x0800),ipv4(src=10.0.0.5,dst=10.0.0.6,proto=6,tos=0,ttl=64,frag=no),tcp(src=8,dst=9),tcp_flags(ack)
])
OVS_VSWITCHD_STOP
AT_CLEANUP


m4_define([DPIF_NETDEV_DUMMY_IFACE],
  [AT_SETUP([dpif-netdev - $1 interface])
   # Create br0 with interfaces p1 and p7
   #    and br1 with interfaces p2 and p8
   # with p1 and p2 connected via unix domain socket
   OVS_VSWITCHD_START(
     [add-port br0 p1 -- set interface p1 type=$1 options:pstream=punix:$OVS_RUNDIR/p0.sock ofport_request=1 -- \
      add-port br0 p7 -- set interface p7 ofport_request=7 type=$1 -- \
      add-br br1 -- \
      set bridge br1 other-config:hwaddr=aa:66:aa:66:00:00 -- \
      set bridge br1 datapath-type=dummy other-config:datapath-id=1234 \
                     fail-mode=secure -- \
      add-port br1 p2 -- set interface p2 type=$1 options:stream=unix:$OVS_RUNDIR/p0.sock ofport_request=2 -- \
      add-port br1 p8 -- set interface p8 ofport_request=8 type=$1 --], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,8,8,8,8"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:dbg dpif_netdev:dbg])

   AT_CHECK([ovs-ofctl add-flow br0 action=normal])
   AT_CHECK([ovs-ofctl add-flow br1 action=normal])
   ovs-appctl time/stop
   ovs-appctl time/warp 5000
   AT_CHECK([ovs-appctl netdev-dummy/receive p7 'in_port(7),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])
   AT_CHECK([ovs-appctl netdev-dummy/receive p8 'in_port(8),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:0b,dst=50:54:00:00:00:0c),eth_type(0x0800),ipv4(src=10.0.0.3,dst=10.0.0.4,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])
   ovs-appctl time/warp 100
   sleep 1  # wait for forwarders process packets

   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:0b,dst=50:54:00:00:00:0c),eth_type(0x0800),ipv4(frag=no), actions: <del>
recirc_id(0),in_port(2),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(frag=no), actions: <del>
recirc_id(0),in_port(7),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(frag=no), actions: <del>
recirc_id(0),in_port(8),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:0b,dst=50:54:00:00:00:0c),eth_type(0x0800),ipv4(frag=no), actions: <del>
])

   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_DUMMY_IFACE([dummy])
DPIF_NETDEV_DUMMY_IFACE([dummy-pmd])

m4_define([DPIF_NETDEV_MISS_FLOW_INSTALL],
  [AT_SETUP([dpif-netdev - miss upcall key matches flow_install - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 \
      -- set interface p1 type=$1 options:pstream=punix:$OVS_RUNDIR/p0.sock \
      -- set bridge br0 datapath-type=dummy \
                        other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:dbg dpif_netdev:dbg])

   AT_CHECK([ovs-ofctl add-flow br0 action=normal])
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])
   ovs-appctl ofproto/trace 'in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)
])
   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(frag=no), actions: <del>
])

   # Now, the same again without megaflows.
   AT_CHECK([ovs-appctl upcall/disable-megaflows], [0], [megaflows disabled
])
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])

   OVS_WAIT_UNTIL([test `grep -c "miss upcall" ovs-vswitchd.log` -ge 2])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)
])
   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(-new-est-rel-rpl-inv-trk-snat-dnat),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0), actions: <del>
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(frag=no), actions: <del>
])

   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_MISS_FLOW_INSTALL([dummy])
DPIF_NETDEV_MISS_FLOW_INSTALL([dummy-pmd])

m4_define([DPIF_NETDEV_FLOW_PUT_MODIFY],
  [AT_SETUP([dpif-netdev - datapath flow modification - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 -- set interface p1 type=$1 ofport_request=1 options:pstream=punix:$OVS_RUNDIR/p1.sock -- \
      add-port br0 p2 -- set interface p2 type=$1 ofport_request=2 options:pstream=punix:$OVS_RUNDIR/p2.sock -- \
      set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:file:dbg dpif_netdev:file:dbg])

   # Add a flow that directs some packets received on p1 to p2 and the
   # rest back out p1.
   AT_CHECK([ovs-ofctl del-flows br0])
   AT_CHECK([ovs-ofctl add-flow br0 priority=1,ip,in_port=1,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,actions=output:2])
   AT_CHECK([ovs-ofctl add-flow br0 priority=0,in_port=1,actions=IN_PORT])

   # Inject a packet of the form that should go to p2.
   packet="in_port(1),packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=1000,pcp=5),encap(eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=0,tos=0,ttl=64,frag=no))"
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=1000,pcp=5),encap(eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=0,tos=0,ttl=64,frag=no))
])
   ovs-appctl revalidator/wait
   # Dump the datapath flow to see that it goes to p2 ("actions:2").
   AT_CHECK([ovs-appctl dpif/dump-flows br0], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=1000,pcp=5/0x0),encap(eth_type(0x0800),ipv4(frag=no)), packets:0, bytes:0, used:never, actions:2
])

   # Delete the flows, then add new flows that would not match the same
   # packet as before.
   AT_CHECK([ovs-ofctl del-flows br0])
   AT_CHECK([ovs-ofctl add-flow br0 priority=1,in_port=1,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,dl_type=0x0801,actions=output:2])
   AT_CHECK([ovs-ofctl add-flow br0 priority=0,in_port=1,actions=IN_PORT])

   # Wait for flow revalidation
   ovs-appctl revalidator/wait

   # Inject the same packet again.
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64])

   ovs-appctl revalidator/wait
   # Dump the datapath flow to see that it goes to p1 ("actions:IN_PORT").
   AT_CHECK([ovs-appctl dpif/dump-flows br0 | strip_timers], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=1000,pcp=5/0x0),encap(eth_type(0x0800),ipv4(frag=no)), packets:1, bytes:64, used:0.0s, actions:1
])
   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_FLOW_PUT_MODIFY([dummy])
DPIF_NETDEV_FLOW_PUT_MODIFY([dummy-pmd])


m4_define([DPIF_NETDEV_MISS_FLOW_DUMP],
  [AT_SETUP([dpif-netdev - miss upcall key matches flow_dump - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 \
      -- set interface p1 type=$1 options:pstream=punix:$OVS_RUNDIR/p0.sock \
      -- set bridge br0 datapath-type=dummy \
                        other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl upcall/disable-ufid], [0], [Datapath dumping tersely using UFID disabled
], [])
   AT_CHECK([ovs-appctl vlog/set dpif:dbg dpif_netdev:dbg])
   AT_CHECK([ovs-appctl vlog/disable-rate-limit dpif])

   AT_CHECK([ovs-ofctl add-flow br0 action=normal])
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)
])
   ovs-appctl revalidator/wait
   AT_CHECK([filter_flow_dump < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),dp_hash(0/0),skb_priority(0/0),in_port(1),skb_mark(0/0),ct_state(0/0),ct_zone(0/0),ct_mark(0/0),ct_label(0/0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2/0.0.0.0,dst=10.0.0.1/0.0.0.0,proto=1/0,tos=0/0,ttl=64/0,frag=no),icmp(type=8/0,code=0/0), packets:0, bytes:0, used:never, actions: <del>
])

   # Now, the same again without megaflows.
   AT_CHECK([ovs-appctl upcall/disable-megaflows], [0], [megaflows disabled
])
   AT_CHECK([ovs-appctl upcall/disable-ufid], [0], [Datapath dumping tersely using UFID disabled
], [])
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 'in_port(1),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)'])

   OVS_WAIT_UNTIL([test `grep -c "miss upcall" ovs-vswitchd.log` -ge 2])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)
])
   ovs-appctl revalidator/wait
   AT_CHECK([filter_flow_dump < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0/0xff),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0), packets:0, bytes:0, used:never, actions: <del>
recirc_id(0),dp_hash(0/0),skb_priority(0/0),in_port(1),skb_mark(0/0),ct_state(0/0),ct_zone(0/0),ct_mark(0/0),ct_label(0/0),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2/0.0.0.0,dst=10.0.0.1/0.0.0.0,proto=1/0,tos=0/0,ttl=64/0,frag=no),icmp(type=8/0,code=0/0), packets:0, bytes:0, used:never, actions: <del>
])

   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_MISS_FLOW_DUMP([dummy])
DPIF_NETDEV_MISS_FLOW_DUMP([dummy-pmd])

AT_SETUP([dpif-netdev - meters])
# Create br0 with interfaces p1 and p7
#    and br1 with interfaces p2 and p8
# with p1 and p2 connected via unix domain socket
OVS_VSWITCHD_START(
  [add-port br0 p1 -- set interface p1 type=dummy options:pstream=punix:$OVS_RUNDIR/p0.sock ofport_request=1 -- \
   add-port br0 p7 -- set interface p7 ofport_request=7 type=dummy -- \
   add-br br1 -- \
   set bridge br1 other-config:hwaddr=aa:66:aa:66:00:00 -- \
   set bridge br1 datapath-type=dummy other-config:datapath-id=1234 \
                  fail-mode=secure -- \
   add-port br1 p2 -- set interface p2 type=dummy options:stream=unix:$OVS_RUNDIR/p0.sock ofport_request=2 -- \
   add-port br1 p8 -- set interface p8 ofport_request=8 type=dummy --])
AT_CHECK([ovs-appctl vlog/set dpif:dbg dpif_netdev:dbg])

AT_CHECK([ovs-ofctl -O OpenFlow13 add-meter br0 'meter=1 pktps burst stats bands=type=drop rate=1 burst_size=1'])
AT_CHECK([ovs-ofctl -O OpenFlow13 add-meter br0 'meter=2 kbps burst stats bands=type=drop rate=1 burst_size=2'])
AT_CHECK([ovs-ofctl -O OpenFlow13 add-flow br0 'in_port=1 action=meter:1,7'])
AT_CHECK([ovs-ofctl -O OpenFlow13 add-flow br0 'in_port=7 action=meter:2,1'])
AT_CHECK([ovs-ofctl add-flow br1 'in_port=2 action=8'])
AT_CHECK([ovs-ofctl add-flow br1 'in_port=8 action=2'])
ovs-appctl time/stop

AT_CHECK([ovs-ofctl -O OpenFlow13 dump-meters br0], [0], [dnl
OFPST_METER_CONFIG reply (OF1.3) (xid=0x2):
meter=1 pktps burst stats bands=
type=drop rate=1 burst_size=1

meter=2 kbps burst stats bands=
type=drop rate=1 burst_size=2
])

ovs-appctl time/warp 5000
for i in `seq 1 7`; do
  AT_CHECK(
    [ovs-appctl netdev-dummy/receive p7 \
       'in_port(7),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)' --len 60])
done

for i in `seq 1 5`; do
  AT_CHECK(
    [ovs-appctl netdev-dummy/receive p8 \
       'in_port(8),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:0b,dst=50:54:00:00:00:0c),eth_type(0x0800),ipv4(src=10.0.0.3,dst=10.0.0.4,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)' --len 60])
done

sleep 1  # wait for forwarders process packets

# Meter 1 is measuring packets, allowing one packet per second with
# bursts of one packet, so 4 out of 5 packets should hit the drop band.
# Meter 2 is measuring kbps, with burst size 2 (== 2000 bits). 4 packets
# (240 bytes == 1920 bits) pass, but the last three packets should hit the
# drop band.  There should be 80 bits remaining for the next packets.
AT_CHECK([ovs-ofctl -O OpenFlow13 meter-stats br0 | strip_timers], [0], [dnl
OFPST_METER reply (OF1.3) (xid=0x2):
meter:1 flow_count:1 packet_in_count:5 byte_in_count:300 duration:0.0s bands:
0: packet_count:4 byte_count:240

meter:2 flow_count:1 packet_in_count:7 byte_in_count:420 duration:0.0s bands:
0: packet_count:3 byte_count:180
])

# Advance time by 870 ms
ovs-appctl time/warp 870

for i in `seq 1 5`; do
  AT_CHECK(
    [ovs-appctl netdev-dummy/receive p7 \
       'in_port(7),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)' --len 60])

  AT_CHECK(
    [ovs-appctl netdev-dummy/receive p8 \
       'in_port(8),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:0b,dst=50:54:00:00:00:0c),eth_type(0x0800),ipv4(src=10.0.0.3,dst=10.0.0.4,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)' --len 60])
done

sleep 1  # wait for forwarders process packets

# Meter 1 is measuring packets, allowing one packet per second with
# bursts of one packet, so all 5 of the new packets should hit the drop
# band.
# Meter 2 is measuring kbps, with burst size 2 (== 2000 bits). After 870ms
# there should be space for 80 + 870 = 950 bits, so one new 60 byte (480 bit)
# packet should pass, remaining 4 should hit the drop band.  There should be
# 470 bits left.
AT_CHECK([ovs-ofctl -O OpenFlow13 meter-stats br0 | strip_timers], [0], [dnl
OFPST_METER reply (OF1.3) (xid=0x2):
meter:1 flow_count:1 packet_in_count:10 byte_in_count:600 duration:0.0s bands:
0: packet_count:9 byte_count:540

meter:2 flow_count:1 packet_in_count:12 byte_in_count:720 duration:0.0s bands:
0: packet_count:7 byte_count:420
])

# Advance time by 10 ms
ovs-appctl time/warp 10

for i in `seq 1 5`; do
  AT_CHECK(
    [ovs-appctl netdev-dummy/receive p7 \
       'in_port(7),packet_type(ns=0,id=0),eth(src=50:54:00:00:00:09,dst=50:54:00:00:00:0a),eth_type(0x0800),ipv4(src=10.0.0.2,dst=10.0.0.1,proto=1,tos=0,ttl=64,frag=no),icmp(type=8,code=0)' --len 60])
done

sleep 1  # wait for forwarders process packets

# Meter 1 should remain the same as we didn't send anything that should hit it.
# Meter 2 is measuring kbps, with burst size 2 (== 2000 bits). After 10ms
# there should be space for 470 + 10 = 480 bits, so one new 60 byte (480 bit)
# packet should pass, remaining 4 should hit the drop band.
AT_CHECK([ovs-ofctl -O OpenFlow13 meter-stats br0 | strip_timers], [0], [dnl
OFPST_METER reply (OF1.3) (xid=0x2):
meter:1 flow_count:1 packet_in_count:10 byte_in_count:600 duration:0.0s bands:
0: packet_count:9 byte_count:540

meter:2 flow_count:1 packet_in_count:17 byte_in_count:1020 duration:0.0s bands:
0: packet_count:11 byte_count:660
])

ovs-appctl time/warp 5000

AT_CHECK([
ovs-appctl coverage/read-counter datapath_drop_meter
], [0], [dnl
20
])

AT_CHECK([cat ovs-vswitchd.log | filter_flow_install | strip_xout_keep_actions], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), actions:meter(0),7
recirc_id(0),in_port(2),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), actions:8
recirc_id(0),in_port(7),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), actions:meter(1),1
recirc_id(0),in_port(8),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), actions:2
])

AT_CHECK([ovs-ofctl -O OpenFlow13 del-meters br0])

OVS_VSWITCHD_STOP
AT_CLEANUP

m4_define([DPIF_NETDEV_FLOW_HW_OFFLOAD],
  [AT_SETUP([dpif-netdev - partial hw offload - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 -- \
      set interface p1 type=$1 ofport_request=1 options:pstream=punix:$OVS_RUNDIR/p1.sock options:ifindex=1100 -- \
      set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:file:dbg dpif_netdev:file:dbg netdev_dummy:file:dbg])

   AT_CHECK([ovs-vsctl set Open_vSwitch . other_config:hw-offload=true])
   OVS_WAIT_UNTIL([grep "netdev: Flow API Enabled" ovs-vswitchd.log])

   AT_CHECK([ovs-ofctl del-flows br0])
   AT_CHECK([ovs-ofctl add-flow br0 in_port=1,actions=IN_PORT])

   packet="packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=0,tos=0,ttl=64,frag=no)"
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=0,tos=0,ttl=64,frag=no)
])
   # Check that flow successfully offloaded.
   OVS_WAIT_UNTIL([grep "succeed to add netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow put[[create]]: flow match: recirc_id=0,eth,ip,in_port=1,vlan_tci=0x0000/0x1fff,nw_frag=no, mark: 1
])
   # Check that datapath flow installed successfully.
   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), actions: <del>
])
   # Inject the same packet again.
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   # Check for succesfull packet matching with installed offloaded flow.
   AT_CHECK([filter_hw_packet_netdev_dummy < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: packet: ip,vlan_tci=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=127.0.0.1,nw_dst=127.0.0.1,nw_proto=0,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no matches with flow: recirc_id=0,eth,ip,vlan_tci=0x0000/0x1fff,nw_frag=no with mark: 1
])

   ovs-appctl revalidator/wait
   # Dump the datapath flow to see that actions was executed for a packet.
   AT_CHECK([ovs-appctl dpif/dump-flows br0 | strip_timers], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), packets:1, bytes:64, used:0.0s, actions:1
])

   # Wait for datapath flow expiration.
   ovs-appctl time/stop
   ovs-appctl time/warp 15000
   ovs-appctl revalidator/wait

   # Check that flow successfully deleted from HW.
   OVS_WAIT_UNTIL([grep "succeed to delete netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_del < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow del: mark: 1
])
   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_FLOW_HW_OFFLOAD([dummy])
DPIF_NETDEV_FLOW_HW_OFFLOAD([dummy-pmd])


m4_define([DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS],
  [AT_SETUP([dpif-netdev - partial hw offload with packet modifications - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 -- \
      set interface p1 type=$1 ofport_request=1 options:pcap=p1.pcap options:ifindex=1101 -- \
      set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:file:dbg dpif_netdev:file:dbg netdev_dummy:file:dbg])

   AT_CHECK([ovs-vsctl set Open_vSwitch . other_config:hw-offload=true])
   OVS_WAIT_UNTIL([grep "netdev: Flow API Enabled" ovs-vswitchd.log])

   AT_CHECK([ovs-ofctl del-flows br0])

   # Setting flow to modify ipv4 src address and udp dst port to be sure that
   # offloaded packets has correctly initialized l3/l4 offsets.
   AT_CHECK([ovs-ofctl add-flow br0 in_port=1,udp,actions=mod_nw_src:192.168.0.7,mod_tp_dst:3773,output:IN_PORT])

   packet="packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=17,ttl=64,frag=no),udp(src=81,dst=82))"
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),dnl
packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0800),ipv4(src=127.0.0.1,dst=127.0.0.1,proto=17,tos=0,ttl=64,frag=no),udp(src=81,dst=82))
])
   # Check that flow successfully offloaded.
   OVS_WAIT_UNTIL([grep "succeed to add netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow put[[create]]: flow match: recirc_id=0,eth,udp,in_port=1,dl_vlan=99,nw_src=127.0.0.1,nw_frag=no,tp_dst=82, mark: 1
])
   # Check that datapath flow installed successfully.
   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x8100),vlan(vid=99,pcp=7/0x0),encap(eth_type(0x0800),ipv4(src=127.0.0.1,proto=17,frag=no),udp(dst=82)), actions: <del>
])
   # Inject the same packet again.
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   # Check for succesfull packet matching with installed offloaded flow.
   AT_CHECK([filter_hw_packet_netdev_dummy < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: packet: udp,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=127.0.0.1,nw_dst=127.0.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,tp_src=81,tp_dst=82 dnl
matches with flow: recirc_id=0,eth,udp,dl_vlan=99,nw_src=127.0.0.1,nw_frag=no,tp_dst=82 with mark: 1
])

   ovs-appctl revalidator/wait
   # Dump the datapath flow to see that actions was executed for a packet.
   AT_CHECK([ovs-appctl dpif/dump-flows br0 | strip_timers], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x8100),vlan(vid=99,pcp=7/0x0),encap(eth_type(0x0800),ipv4(src=127.0.0.1,proto=17,frag=no),udp(dst=82)), dnl
packets:1, bytes:64, used:0.0s, actions:set(ipv4(src=192.168.0.7)),set(udp(dst=3773)),1
])

   # Wait for datapath flow expiration.
   ovs-appctl time/stop
   ovs-appctl time/warp 15000
   ovs-appctl revalidator/wait

   # Check that flow successfully deleted from HW.
   OVS_WAIT_UNTIL([grep "succeed to delete netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_del < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow del: mark: 1
])

   # Check that ip address and udp port were correctly modified in output packets.
   AT_CHECK([ovs-ofctl parse-pcap p1.pcap], [0], [dnl
udp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=127.0.0.1,nw_dst=127.0.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,tp_src=81,tp_dst=82
udp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=192.168.0.7,nw_dst=127.0.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,tp_src=81,tp_dst=3773
udp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=127.0.0.1,nw_dst=127.0.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,tp_src=81,tp_dst=82
udp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,nw_src=192.168.0.7,nw_dst=127.0.0.1,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,tp_src=81,tp_dst=3773
])

   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS([dummy])
DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS([dummy-pmd])

m4_define([DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS_VID_ARP],
  [AT_SETUP([dpif-netdev - partial hw offload with arp vlan id packet modifications - $1])
   OVS_VSWITCHD_START(
     [add-port br0 p1 -- \
      set interface p1 type=$1 ofport_request=1 options:pcap=p1.pcap options:ifindex=1102 -- \
      set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure], [], [],
      [m4_if([$1], [dummy-pmd], [--dummy-numa="0,0,0,0,1,1,1,1"], [])])
   AT_CHECK([ovs-appctl vlog/set dpif:file:dbg dpif_netdev:file:dbg netdev_dummy:file:dbg])

   AT_CHECK([ovs-vsctl set Open_vSwitch . other_config:hw-offload=true])
   OVS_WAIT_UNTIL([grep "netdev: Flow API Enabled" ovs-vswitchd.log])

   AT_CHECK([ovs-ofctl del-flows br0])

   # Setting flow to modify vlan id with arp packet to be sure that
   # offloaded packets has correctly initialized l3 offset.
   AT_CHECK([ovs-ofctl add-flow br0 in_port=1,arp,dl_vlan=99,actions=mod_vlan_vid=11,output:IN_PORT])

   packet="packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0806),arp(sip=127.0.0.1,tip=127.0.0.1,op=1,sha=00:0b:0c:0d:0e:0f,tha=00:00:00:00:00:00))"
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   OVS_WAIT_UNTIL([grep "miss upcall" ovs-vswitchd.log])
   AT_CHECK([grep -A 1 'miss upcall' ovs-vswitchd.log | tail -n 1], [0], [dnl
recirc_id(0),dp_hash(0),skb_priority(0),in_port(1),skb_mark(0),ct_state(0),ct_zone(0),ct_mark(0),ct_label(0),dnl
packet_type(ns=0,id=0),eth(src=00:06:07:08:09:0a,dst=00:01:02:03:04:05),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0806),arp(sip=127.0.0.1,tip=127.0.0.1,op=1,sha=00:0b:0c:0d:0e:0f,tha=00:00:00:00:00:00))
])
   # Check that flow successfully offloaded.
   OVS_WAIT_UNTIL([grep "succeed to add netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow put[[create]]: flow match: recirc_id=0,eth,arp,in_port=1,dl_vlan=99,dl_vlan_pcp=7, mark: 1
])
   # Check that datapath flow installed successfully.
   AT_CHECK([filter_flow_install < ovs-vswitchd.log | strip_xout], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0806)), actions: <del>
])
   # Inject the same packet again.
   AT_CHECK([ovs-appctl netdev-dummy/receive p1 $packet --len 64], [0])

   # Check for succesfull packet matching with installed offloaded flow.
   AT_CHECK([filter_hw_packet_netdev_dummy < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: packet: arp,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,arp_spa=127.0.0.1,arp_tpa=127.0.0.1,arp_op=1,arp_sha=00:0b:0c:0d:0e:0f,arp_tha=00:00:00:00:00:00 dnl
matches with flow: recirc_id=0,eth,arp,dl_vlan=99,dl_vlan_pcp=7 with mark: 1
])

   ovs-appctl revalidator/wait
   # Dump the datapath flow to see that actions was executed for a packet.
   AT_CHECK([ovs-appctl dpif/dump-flows br0 | strip_timers], [0], [dnl
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x8100),vlan(vid=99,pcp=7),encap(eth_type(0x0806)), dnl
packets:1, bytes:64, used:0.0s, actions:pop_vlan,push_vlan(vid=11,pcp=7),1
])

   # Wait for datapath flow expiration.
   ovs-appctl time/stop
   ovs-appctl time/warp 15000
   ovs-appctl revalidator/wait

   # Check that flow successfully deleted from HW.
   OVS_WAIT_UNTIL([grep "succeed to delete netdev flow" ovs-vswitchd.log])
   AT_CHECK([filter_hw_flow_del < ovs-vswitchd.log | strip_xout], [0], [dnl
p1: flow del: mark: 1
])

   # Check that VLAN ID was correctly modified in output packets.
   AT_CHECK([ovs-ofctl parse-pcap p1.pcap], [0], [dnl
arp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,arp_spa=127.0.0.1,arp_tpa=127.0.0.1,arp_op=1,arp_sha=00:0b:0c:0d:0e:0f,arp_tha=00:00:00:00:00:00
arp,in_port=ANY,dl_vlan=11,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,arp_spa=127.0.0.1,arp_tpa=127.0.0.1,arp_op=1,arp_sha=00:0b:0c:0d:0e:0f,arp_tha=00:00:00:00:00:00
arp,in_port=ANY,dl_vlan=99,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,arp_spa=127.0.0.1,arp_tpa=127.0.0.1,arp_op=1,arp_sha=00:0b:0c:0d:0e:0f,arp_tha=00:00:00:00:00:00
arp,in_port=ANY,dl_vlan=11,dl_vlan_pcp=7,vlan_tci1=0x0000,dl_src=00:06:07:08:09:0a,dl_dst=00:01:02:03:04:05,arp_spa=127.0.0.1,arp_tpa=127.0.0.1,arp_op=1,arp_sha=00:0b:0c:0d:0e:0f,arp_tha=00:00:00:00:00:00
])

   OVS_VSWITCHD_STOP
   AT_CLEANUP])

DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS_VID_ARP([dummy])
DPIF_NETDEV_FLOW_HW_OFFLOAD_OFFSETS_VID_ARP([dummy-pmd])

AT_SETUP([dpif-netdev - check dpctl/add-flow in_port exact match])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set interface p1 type=dummy options:pstream=punix:$OVS_RUNDIR/p0.sock \
   -- set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure])

AT_CHECK([ovs-appctl dpctl/add-flow "eth(),eth_type(0x0800),ipv4()" "3"], [2],
[], [dnl
ovs-vswitchd: updating flow table (Invalid argument)
ovs-appctl: ovs-vswitchd: server returned an error
])
OVS_WAIT_UNTIL([grep "flow: in_port is not an exact match" ovs-vswitchd.log])
OVS_VSWITCHD_STOP(["/flow: in_port is not an exact match/d
/failed to put/d"])
AT_CLEANUP

AT_SETUP([dpif-netdev - check dpctl/add-flow wider ip match])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set interface p1 type=dummy options:pstream=punix:$OVS_RUNDIR/p0.sock \
   -- set bridge br0 datapath-type=dummy])

AT_CHECK([ovs-appctl revalidator/pause])
AT_CHECK([ovs-appctl dpctl/add-flow "in_port(1),eth_type(0x0800),ipv4(src=0.0.0.0/192.0.0.0,dst=0.0.0.0/192.0.0.0,frag=no)" "3"])
AT_CHECK([ovs-appctl dpctl/add-flow "in_port(1),eth_type(0x0800),ipv4(src=192.1.1.1/0.0.0.0,dst=49.1.1.1/0.0.0.0,frag=no)" "3"])
AT_CHECK([ovs-appctl revalidator/resume])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([dpif-netdev - check tx packet checksum offloading])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set interface p1 type=dummy options:pstream=punix:$OVS_RUNDIR/p0.sock \
   -- set bridge br0 datapath-type=dummy \
                     other-config:datapath-id=1234 fail-mode=secure])

AT_CHECK([ovs-vsctl get interface p1 status | sed -n 's/^{\(.*\).*}$/\1/p'], [0], [dnl
tx_geneve_tso_offload="false", tx_gre_tso_offload="false", tx_ip_csum_offload="false", tx_out_ip_csum_offload="false", tx_out_udp_csum_offload="false", tx_sctp_csum_offload="false", tx_tcp_csum_offload="false", tx_tcp_seg_offload="false", tx_udp_csum_offload="false", tx_vxlan_tso_offload="false"
], [])

AT_CHECK([ovs-vsctl get interface br0 status | sed -n 's/^{\(.*\).*}$/\1/p'], [0], [dnl
tx_geneve_tso_offload="false", tx_gre_tso_offload="false", tx_ip_csum_offload="false", tx_out_ip_csum_offload="false", tx_out_udp_csum_offload="false", tx_sctp_csum_offload="false", tx_tcp_csum_offload="false", tx_tcp_seg_offload="false", tx_udp_csum_offload="false", tx_vxlan_tso_offload="false"
], [])

OVS_VSWITCHD_STOP
AT_CLEANUP

# SEND_UDP_PKTS([p_name], [p_ofport])
#
# Sends 128 packets to port 'p_name' with different UDP destination ports.
m4_define([SEND_UDP_PKTS],
   [
    for i in `seq 1 128`; do
      pkt="in_port($2),eth(src=50:54:00:00:00:05,dst=50:54:00:00:01:00),eth_type(0x0800),ipv4(src=10.0.1.1,dst=10.0.0.1,proto=17),udp(src=1000,dst=$i)"
      ovs-appctl netdev-dummy/receive $1 $pkt --len 256
    done
   ]
)

AT_SETUP([dpif-netdev - tx packet steering])
OVS_VSWITCHD_START(
  [add-port br0 p1 -- set Interface p1 type=dummy-pmd ofport_request=1], [], [], [--dummy-numa 0])

dnl 'thread' mode, packets are expected to be transmitted on a single
dnl queue since there is only one PMD thread.

AT_CHECK([ovs-vsctl add-port br0 p2 -- set Interface p2 type=dummy-pmd ofport_request=2 options:n_txq=2 other_config:tx-steering=thread])
AT_CHECK([ovs-ofctl add-flow br0 in_port=1,actions=output:2])

AT_CHECK([SEND_UDP_PKTS([p1], [1])])

OVS_WAIT_UNTIL([test `ovs-vsctl get Interface p2 statistics:tx_packets` -eq 128])
AT_CHECK([ovs-vsctl get Interface p2 statistics], [], [stdout])
AT_CHECK([test `ovs-vsctl get Interface p2 statistics:tx_q0_packets` -eq 0 -a dnl
               `ovs-vsctl get Interface p2 statistics:tx_q1_packets` -eq 128 || dnl
          test `ovs-vsctl get Interface p2 statistics:tx_q0_packets` -eq 128 -a dnl
               `ovs-vsctl get Interface p2 statistics:tx_q1_packets` -eq 0])

AT_CHECK([ovs-vsctl del-port p2])

dnl 'hash' mode, packets are expected to be transmitted on both
dnl queues, based on their hash value.

AT_CHECK([ovs-vsctl add-port br0 p2 -- set Interface p2 type=dummy-pmd ofport_request=2 options:n_txq=2 other_config:tx-steering=hash])
AT_CHECK([ovs-ofctl add-flow br0 in_port=1,actions=output:2])

AT_CHECK([SEND_UDP_PKTS([p1], [1])])

OVS_WAIT_UNTIL([test `ovs-vsctl get Interface p2 statistics:tx_packets` -eq 128])
AT_CHECK([ovs-vsctl get Interface p2 statistics], [], [stdout])

AT_CHECK([test `ovs-vsctl get Interface p2 statistics:tx_q0_packets` -gt 0 -a dnl
               `ovs-vsctl get Interface p2 statistics:tx_q1_packets` -gt 0])

AT_CHECK([ovs-vsctl del-port p2])

dnl 'hash' mode with hw-offload enabled, packets are expected to be transmitted on both
dnl queues, based on their hash value.

AT_CHECK([ovs-vsctl set Open_vSwitch . other_config:hw-offload=true])
AT_CHECK([ovs-vsctl add-port br0 p2 -- set Interface p2 type=dummy-pmd ofport_request=2 options:n_txq=2 other_config:tx-steering=hash])
AT_CHECK([ovs-ofctl add-flow br0 in_port=1,actions=output:2])

AT_CHECK([SEND_UDP_PKTS([p1], [1])])

OVS_WAIT_UNTIL([test `ovs-vsctl get Interface p2 statistics:tx_packets` -eq 128])
AT_CHECK([ovs-vsctl get Interface p2 statistics], [], [stdout])

AT_CHECK([test `ovs-vsctl get Interface p2 statistics:tx_q0_packets` -gt 0 -a dnl
               `ovs-vsctl get Interface p2 statistics:tx_q1_packets` -gt 0])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([userspace offload - ip csum offload])
OVS_VSWITCHD_START(
  [add-br br1 -- set bridge br1 datapath-type=dummy -- \
   add-port br1 p1 -- \
       set Interface p1 type=dummy -- \
   add-port br1 p2 -- \
       set Interface p2 type=dummy --])

# Modify the ip_dst addr to force changing the IP csum.
AT_CHECK([ovs-ofctl add-flow br1 in_port=p1,actions=mod_nw_dst:192.168.1.1,output:p2])

flow_s="\
  eth_src=8a:bf:7e:2f:05:84,eth_dst=0a:8f:39:4f:e0:73,dl_type=0x0800,\
  nw_src=192.168.123.2,nw_dst=192.168.123.1,nw_proto=6,nw_ttl=64,nw_frag=no,\
  tp_src=54392,tp_dst=5201,tcp_flags=ack"

good_frame=$(ovs-ofctl compose-packet --bare "${flow_s}")

# Check if no offload remains ok.
AT_CHECK([ovs-vsctl set Interface p2 options:tx_pcap=p2.pcap])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=false])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=false])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 ${good_frame}])

# Checksum should change to 0x990 with ip_dst changed to 192.168.1.1
# by the datapath while processing the packet.
flow_expected=$(echo "${flow_s}" | sed 's/192.168.123.1/192.168.1.1/g')
good_expected=$(ovs-ofctl compose-packet --bare "${flow_expected}")
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p2.pcap.txt], [0], [${good_expected}
])

# Check if packets entering the datapath with csum offloading
# enabled gets the csum updated properly by egress handling
# in the datapath and not by the netdev.
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=false])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=true])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 ${good_frame}])
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p2.pcap.txt], [0], [${good_expected}
])

# Check if packets entering the datapath with csum offloading
# enabled gets the csum updated properly by netdev and not
# by the datapath.
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=true])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=true])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 ${good_frame}
])
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p2.pcap.txt], [0], [${good_expected}
])

# Push a packet with bad csum and offloading disabled to check
# if the datapath updates the csum, but does not fix the issue.
bad_frame=$(ovs-ofctl compose-packet --bare --bad-csum "${flow_s}")
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=false])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=false])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 ${bad_frame}])
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])
bad_expected=$(ovs-ofctl compose-packet --bare --bad-csum "${flow_expected}")
AT_CHECK_UNQUOTED([tail -n 1 p2.pcap.txt], [0], [${bad_expected}
])

# Push a packet with bad csum and offloading enabled to check
# if the driver updates and fixes the csum.
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=true])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=true])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 ${bad_frame}])
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p2.pcap.txt], [0], [${good_expected}
])

dnl Test with IP optional fields in a valid packet.  Note that neither this
dnl packet nor the following one contain a correct checksum.  OVS is
dnl expected to replace this dummy checksum with a valid one if possible.
m4_define([OPT_PKT], m4_join([],
dnl eth(dst=aa:aa:aa:aa:aa:aa,src=bb:bb:bb:bb:bb:bb,type=0x0800)
[aaaaaaaaaaaabbbbbbbbbbbb0800],
dnl ipv4(dst=10.0.0.2,src=10.0.0.1,proto=1,len=60,tot_len=68,csum=0xeeee)
[4f000044abab00004001eeee0a0000010a000002],
dnl IPv4 Opt: type 7 (Record Route) len 39 + type 0 (EOL).
[07270c010203040a000003000000000000000000],
[0000000000000000000000000000000000000000],
dnl icmp(type=8,code=0), csum 0x3e2f incorrect, should be 0x412f.
[08003e2fb6d00000]))

dnl IP header indicates optional fields but doesn't contain any.
m4_define([MICROGRAM], m4_join([],
dnl eth(dst=aa:aa:aa:aa:aa:aa,src=bb:bb:bb:bb:bb:bb,type=0x0800)
[aaaaaaaaaaaabbbbbbbbbbbb0800],
dnl ipv4(dst=10.0.0.2,src=10.0.0.1,proto=1,len=60,tot_len=68,csum=0xeeee)
[4f000044abab00004001eeee0a0000010a000002]))

AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum=true])
AT_CHECK([ovs-vsctl set Interface p1 options:ol_ip_csum_set_good=true])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 OPT_PKT])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 MICROGRAM])
AT_CHECK([ovs-pcap p2.pcap > p2.pcap.txt 2>&1])

dnl Build the expected modified packets.  The first packet has a valid IPv4
dnl checksum and modified destination IP address.  The second packet isn't
dnl expected to change.
AT_CHECK([echo "OPT_PKT" | sed -e "s/0a000002/c0a80101/" -e "s/eeee/dd2e/" > expout])
AT_CHECK([echo "MICROGRAM" >> expout])
AT_CHECK([tail -n 2 p2.pcap.txt], [0], [expout])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([userspace offload - tso])
OVS_VSWITCHD_START(
  [set Open_vSwitch . other_config:userspace-tso-enable=true -- \
   add-br br1 -- set bridge br1 datapath-type=dummy -- \
   add-port br1 p1 -- \
       set Interface p1 type=dummy -- \
   add-port br1 p2 -- \
       set Interface p2 type=dummy])

dnl Simple passthrough rule.
AT_CHECK([ovs-ofctl add-flow br1 in_port=p1,actions=output:p2])

flow_s="in_port(1),eth(src=8a:bf:7e:2f:05:84,dst=0a:8f:39:4f:e0:73),eth_type(0x0800), \
        ipv4(src=192.168.123.2,dst=192.168.123.1,proto=6,tos=1,ttl=64,frag=no), \
        tcp(src=54392,dst=5201),tcp_flags(ack)"

flow_s_v6="in_port(1),eth(src=8a:bf:7e:2f:05:84,dst=0a:8f:39:4f:e0:73),eth_type(0x86dd), \
           ipv6(src=2001:cafe::88,dst=2001:cafe::92,proto=6), \
           tcp(src=54392,dst=5201),tcp_flags(ack)"

dnl Send from tso to no-tso.
AT_CHECK([ovs-vsctl set Interface p2 options:tx_pcap=p2.pcap -- \
                    set Interface p1 options:ol_ip_csum=true -- \
                    set Interface p1 options:ol_ip_csum_set_good=false -- \
                    set Interface p1 options:ol_tso_segsz=500])

AT_CHECK([ovs-appctl netdev-dummy/receive p1 "${flow_s}" --len 2054])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 "${flow_s_v6}" --len 2074])

dnl Send from tso to tso.
AT_CHECK([ovs-vsctl set Interface p2 options:ol_ip_csum=true -- \
                    set Interface p2 options:ol_ip_csum_set_good=false -- \
                    set Interface p2 options:ol_tso_segsz=500])

AT_CHECK([ovs-appctl netdev-dummy/receive p1 "${flow_s}" --len 2054])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 "${flow_s_v6}" --len 2074])

dnl Check that first we have:
dnl  - 4x IPv4 500 byte payloads
dnl  - 4x IPv6 500 byte payloads
dnl  - one IPv4 2000 byte payload, and
dnl  - one IPv6 2000 byte payload
zero500=$(printf '0%.0s' $(seq 1000))
AT_CHECK_UNQUOTED([ovs-pcap p2.pcap], [0], [dnl
[0a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02c0a87b01]dnl
[d47814510000000000000000501000004dc20000${zero500}]
[0a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02c0a87b01]dnl
[d4781451000001f400000000501000004bce0000${zero500}]
[0a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02c0a87b01]dnl
[d4781451000003e8000000005010000049da0000${zero500}]
[0a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02c0a87b01]dnl
[d4781451000005dc000000005010000047e60000${zero500}]
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000]dnl
[882001cafe000000000000000000000092d4781451000000000000000050100000edfd0000]dnl
[${zero500}]
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000]dnl
[882001cafe000000000000000000000092d4781451000001f40000000050100000ec090000]dnl
[${zero500}]
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000]dnl
[882001cafe000000000000000000000092d4781451000003e80000000050100000ea150000]dnl
[${zero500}]
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000]dnl
[882001cafe000000000000000000000092d4781451000005dc0000000050100000e8210000]dnl
[${zero500}]
[0a8f394fe0738abf7e2f05840800450107f8000000004006fbaac0a87b02c0a87b01]dnl
[d478145100000000000000005010000047e60000${zero500}${zero500}${zero500}${zero500}]
[0a8f394fe0738abf7e2f058486dd6000000007e406002001cafe0000000000000000000000]dnl
[882001cafe000000000000000000000092d4781451000000000000000050100000e8210000]dnl
[${zero500}${zero500}${zero500}${zero500}]
])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([userspace offload - tunnel tso fallback])
OVS_VSWITCHD_START([set Open_vSwitch . other_config:userspace-tso-enable=true \
                    -- add-br br1 -- set bridge br1 datapath-type=dummy \
                       other-config:hwaddr=aa:55:aa:55:00:03 \
                    -- add-port br1 p1 -- set Interface p1 type=dummy \
                       ofport_request=1])
AT_CHECK([ovs-vsctl add-br int-br -- set bridge int-br datapath_type=dummy \
                    -- add-port int-br t1 -- set Interface t1 type=vxlan \
                       options:remote_ip=1.1.2.92 options:key=123 \
                       options:csum=true ofport_request=2 \
                    -- add-port int-br t2 -- set Interface t2 type=geneve \
                       options:remote_ip=1.1.2.92 options:key=123 \
                       options:csum=true ofport_request=3 \
                    -- add-port int-br t3 -- set Interface t3 type=vxlan \
                       options:remote_ip=2001:cafe::93 options:key=123 \
                       options:csum=true ofport_request=4 \
                    -- add-port int-br t4 -- set Interface t4 type=geneve \
                       options:remote_ip=2001:cafe::93 options:key=123 \
                       options:csum=true ofport_request=5 \
                    -- add-port int-br t5 -- set Interface t5 type=gre \
                       options:remote_ip=2001:cafe::93 options:key=123 \
                       options:csum=true ofport_request=6 \
                    -- add-port int-br t6 -- set Interface t6 type=gre \
                       options:remote_ip=1.1.2.92 options:key=123 \
                       options:csum=false ofport_request=7], [0])

dnl The final tunnel intentionally has checksum turned off to exercise a
dnl different code path, there is no GRE checksum offload anyways.

m4_define([IPV4_TSO], [m4_join([,],
  [eth(src=8a:bf:7e:2f:05:84,dst=0a:8f:39:4f:e0:73),eth_type(0x0800)],
  [ipv4(src=192.168.123.2,dst=192.168.123.1,proto=6,tos=1,ttl=64,frag=no)],
  [tcp(src=54392,dst=5201),tcp_flags(ack)])])

m4_define([IPV6_TSO], [m4_join([,],
  [eth(src=8a:bf:7e:2f:05:84,dst=0a:8f:39:4f:e0:73),eth_type(0x86dd)],
  [ipv6(src=2001:cafe::88,dst=2001:cafe::92,proto=6)],
  [tcp(src=54392,dst=5201),tcp_flags(ack)])])

dnl Setup dummy interface tunnel connectivity.
AT_CHECK([ovs-appctl netdev-dummy/ip4addr br1 1.1.2.88/24], [0], [OK
])
AT_CHECK([ovs-appctl netdev-dummy/ip6addr br1 2001:cafe::88/24], [0], [OK
])
AT_CHECK([ovs-appctl tnl/neigh/set br1 1.1.2.92 aa:bb:cc:00:00:01], [0], [OK
])
AT_CHECK([ovs-appctl tnl/neigh/set br1 2001:cafe::93 aa:bb:cc:00:00:06], [0],
         [OK
])
AT_CHECK([ovs-appctl tnl/egress_port_range 57363 57363], [0], [OK
])
AT_CHECK([ovs-ofctl add-flow br1 action=normal])
AT_CHECK([ovs-ofctl add-flow int-br action=normal])

dnl Configure the TX interface to segment.
AT_CHECK([ovs-vsctl set Interface p1 options:tx_pcap=p1.pcap -- \
                    set Interface int-br options:ol_ip_csum=true -- \
                    set Interface int-br options:ol_ip_csum_set_good=false -- \
                    set Interface int-br options:ol_tso_segsz=500])

AT_CHECK([ovs-appctl netdev-dummy/receive int-br "IPV4_TSO" \
          --len 2054])
AT_CHECK([ovs-appctl netdev-dummy/receive int-br "IPV6_TSO" \
          --len 2074])

dnl Check that first we have the following packets:
dnl - IPv4 VXLAN tunnel with IPv4 payload
dnl - IPv4 VXLAN tunnel with IPv6 payload
dnl - IPv6 VXLAN tunnel with IPv4 payload
dnl - IPv6 VXLAN tunnel with IPv6 payload
dnl - IPv4 Geneve tunnel with IPv4 payload
dnl - IPv4 Geneve tunnel with IPv6 payload
dnl - IPv6 Geneve tunnel with IPv4 payload
dnl - IPv6 Geneve tunnel with IPv6 payload
dnl - IPv6 Geneve tunnel with IPv4 payload
dnl - IPv6 Geneve tunnel with IPv6 payload
dnl - IPv4 GRE tunnel with IPv4 payload
dnl - IPv4 GRE tunnel with IPv6 payload
dnl - IPv6 GRE tunnel with IPv4 payload
dnl - IPv6 GRE tunnel with IPv6 payload
dnl These are sorted since OVS may send payloads to the tunnels in any order.
zero400=$(printf '0%.0s' $(seq 800))
zero100=$(printf '0%.0s' $(seq 200))
AT_CHECK_UNQUOTED([ovs-pcap p1.pcap | sort], [0], [dnl
[aabbcc000001aa55aa55000308004500025a00004000402f31c0010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe000000000000000000000092d4781451]dnl
[000000000000000050100000edfd0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500025a00014000402f31bf010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe000000000000000000000092d4781451]dnl
[000001f40000000050100000ec090000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500025a00024000402f31be010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe000000000000000000000092d4781451]dnl
[000003e80000000050100000ea150000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500025a00034000402f31bd010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe000000000000000000000092d4781451]dnl
[000005dc0000000050100000e8210000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200004000401131d6010102580101025ce01312b5024e5f360800000000007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000000000000000050100000edfd0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200004000401131d6010102580101025ce01317c1024efcd10000655800007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000000000000000050100000edfd0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200014000401131d5010102580101025ce01312b5024e5f360800000000007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000001f40000000050100000ec090000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200014000401131d5010102580101025ce01317c1024efcd10000655800007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000001f40000000050100000ec090000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200024000401131d4010102580101025ce01312b5024e5f360800000000007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000003e80000000050100000ea150000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200024000401131d4010102580101025ce01317c1024efcd10000655800007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000003e80000000050100000ea150000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200034000401131d3010102580101025ce01312b5024e5f360800000000007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000005dc0000000050100000e8210000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004500026200034000401131d3010102580101025ce01317c1024efcd10000655800007b00]dnl
[0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000092d4781451000005dc0000000050100000e8210000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024600004000402f31d3010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058408004501021c0000000040060187c0a87b02c0a87b01d47814510000000000000000501000004dc20000]dnl
[${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024600014000402f31d2010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058408004501021c0001000040060186c0a87b02c0a87b01d4781451000001f400000000501000004bce0000]dnl
[${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024600024000402f31d1010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058408004501021c0002000040060185c0a87b02c0a87b01d4781451000003e8000000005010000049da0000]dnl
[${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024600034000402f31d0010102580101025c200065580000007b0a8f394fe0738abf]dnl
[7e2f058408004501021c0003000040060184c0a87b02c0a87b01d4781451000005dc000000005010000047e60000]dnl
[${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00004000401131e9010102580101025ce01312b5023abd990800000000007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02c0a87b01d4781451000000000000000050100000]dnl
[4dc20000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00004000401131e9010102580101025ce01317c1023a5b350000655800007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02c0a87b01d4781451000000000000000050100000]dnl
[4dc20000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00014000401131e8010102580101025ce01312b5023abd990800000000007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02c0a87b01d4781451000001f40000000050100000]dnl
[4bce0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00014000401131e8010102580101025ce01317c1023a5b350000655800007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02c0a87b01d4781451000001f40000000050100000]dnl
[4bce0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00024000401131e7010102580101025ce01312b5023abd990800000000007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02c0a87b01d4781451000003e80000000050100000]dnl
[49da0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00024000401131e7010102580101025ce01317c1023a5b350000655800007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02c0a87b01d4781451000003e80000000050100000]dnl
[49da0000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00034000401131e6010102580101025ce01312b5023abd990800000000007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02c0a87b01d4781451000005dc0000000050100000]dnl
[47e60000${zero100}${zero400}]
[aabbcc000001aa55aa55000308004501024e00034000401131e6010102580101025ce01317c1023a5b350000655800007b00]dnl
[0a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02c0a87b01d4781451000005dc0000000050100000]dnl
[47e60000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60000000024a2f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a0006558da8e00000000007b0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000]dnl
[000000882001cafe000000000000000000000092d4781451000005dc0000000050100000e8210000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60000000024a2f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a0006558dc8200000000007b0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000]dnl
[000000882001cafe000000000000000000000092d4781451000003e80000000050100000ea150000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60000000024a2f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a0006558de7600000000007b0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000]dnl
[000000882001cafe000000000000000000000092d4781451000001f40000000050100000ec090000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60000000024a2f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a0006558e06a00000000007b0a8f394fe0738abf7e2f058486dd60000000020806002001cafe0000000000000000]dnl
[000000882001cafe000000000000000000000092d4781451000000000000000050100000edfd0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5024e8ed10800000000007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000000000000000050100000edfd0000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5024e8ed10800000000007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000001f40000000050100000ec090000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5024e8ed10800000000007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000003e80000000050100000ea150000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5024e8ed10800000000007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000005dc0000000050100000e8210000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1024e2c6d0000655800007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000000000000000050100000edfd0000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1024e2c6d0000655800007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000001f40000000050100000ec090000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1024e2c6d0000655800007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000003e80000000050100000ea150000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd60000000024e11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1024e2c6d0000655800007b000a8f394fe0738abf7e2f058486dd60000000020806002001cafe00000000]dnl
[00000000000000882001cafe000000000000000000000092d4781451000005dc0000000050100000e8210000${zero100}]dnl
[${zero400}]
[aabbcc000006aa55aa55000386dd6010000002362f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a00065583a4e00000000007b0a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02c0a87b01]dnl
[d4781451000005dc000000005010000047e60000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd6010000002362f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a00065583c4300000000007b0a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02c0a87b01]dnl
[d4781451000003e8000000005010000049da0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd6010000002362f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a00065583e3800000000007b0a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02c0a87b01]dnl
[d4781451000001f400000000501000004bce0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd6010000002362f402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093a0006558402d00000000007b0a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02c0a87b01]dnl
[d47814510000000000000000501000004dc20000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5023aed340800000000007b000a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02]dnl
[c0a87b01d47814510000000000000000501000004dc20000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5023aed340800000000007b000a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02]dnl
[c0a87b01d4781451000001f400000000501000004bce0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5023aed340800000000007b000a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02]dnl
[c0a87b01d4781451000003e8000000005010000049da0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01312b5023aed340800000000007b000a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02]dnl
[c0a87b01d4781451000005dc000000005010000047e60000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1023a8ad00000655800007b000a8f394fe0738abf7e2f058408004501021c0000000040060187c0a87b02]dnl
[c0a87b01d47814510000000000000000501000004dc20000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1023a8ad00000655800007b000a8f394fe0738abf7e2f058408004501021c0001000040060186c0a87b02]dnl
[c0a87b01d4781451000001f400000000501000004bce0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1023a8ad00000655800007b000a8f394fe0738abf7e2f058408004501021c0002000040060185c0a87b02]dnl
[c0a87b01d4781451000003e8000000005010000049da0000${zero100}${zero400}]
[aabbcc000006aa55aa55000386dd60100000023a11402001cafe0000000000000000000000882001cafe0000000000000000]dnl
[00000093e01317c1023a8ad00000655800007b000a8f394fe0738abf7e2f058408004501021c0003000040060184c0a87b02]dnl
[c0a87b01d4781451000005dc000000005010000047e60000${zero100}${zero400}]
])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([dpif-netdev - revalidators handle dp modification fail correctly])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set interface p1 type=dummy \
   -- set bridge br0 datapath-type=dummy \
   -- add-port br0 p2 \
   -- set interface p2 type=dummy --
   ])

AT_CHECK([ovs-ofctl add-flow br0 'table=0,in_port=p1,actions=p2'])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 'ipv4(src=10.0.0.1,dst=10.0.0.2),tcp(src=1,dst=2)'])
AT_CHECK([ovs-appctl netdev-dummy/receive p1 'ipv4(src=10.0.0.1,dst=10.0.0.2),tcp(src=1,dst=2)'])

AT_CHECK([ovs-appctl dpctl/dump-flows | sed 's/.*thread://' | strip_xout_keep_actions ], [0], [
recirc_id(0),in_port(1),packet_type(ns=0,id=0),eth_type(0x0800),ipv4(frag=no), packets:0, bytes:0, used:0.0s, actions:2
])

dnl Wait for the dp flow to enter OPERATIONAL state.
AT_CHECK([ovs-appctl revalidator/wait])

AT_CHECK([ovs-appctl revalidator/pause])

dnl Delete all dp flows, so flow modification will fail.
AT_CHECK([ovs-appctl dpctl/del-flows])

AT_CHECK([ovs-appctl revalidator/resume])

dnl Replace OpenFlow rules, trigger revalidation and wait for it to complete.
AT_CHECK([echo 'table=0,in_port=p1,ip actions=ct(commit)' | ovs-ofctl --bundle replace-flows br0 -])
AT_CHECK([ovs-appctl revalidator/wait])

dnl Inconsistent ukey should be deleted.
AT_CHECK([ovs-appctl upcall/show | grep keys | grep -q -v 0], [1])

dnl Check the log for the flow modification error.
AT_CHECK([grep -q -E ".*failed to put.*$" ovs-vswitchd.log])

dnl Remove warning logs to let test suite pass.
OVS_VSWITCHD_STOP(["dnl
  /.*failed to put.*$/d
  /.*failed to flow_del.*$/d"])
AT_CLEANUP

AT_SETUP([dpif-netdev - MFEX Autovalidator])
AT_SKIP_IF([! $PYTHON3 -c "import scapy"], [], [])
AT_SKIP_IF([! $PYTHON3 $srcdir/genpkts.py 2000 > packets])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set Interface p1 type=dummy-pmd], [], [], [--dummy-numa="0,0,0,0,1,1,1,1"])

AT_SKIP_IF([! ovs-appctl dpif-netdev/miniflow-parser-get | sed 1,4d | grep "True"], [], [dnl
])

AT_CHECK([ovs-appctl dpif-netdev/dpif-impl-set dpif_avx512], [0], [dnl
DPIF implementation set to dpif_avx512.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set autovalidator], [0], [dnl
Miniflow extract implementation set to autovalidator.
])

cat packets | while read line; do
  AT_CHECK([ovs-appctl netdev-dummy/receive p1 $line], [0], [ignore])
done

OVS_WAIT_UNTIL([test `ovs-vsctl get interface p1 statistics | grep -oP 'rx_packets=\s*\K\d+'` -ge 16000])

OVS_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([dpif-netdev - MFEX Autovalidator Fuzzy])
AT_SKIP_IF([! $PYTHON3 -c "import scapy"], [], [])
AT_SKIP_IF([! $PYTHON3 $srcdir/genpkts.py 2000 fuzzy > packets])
OVS_VSWITCHD_START(
  [add-port br0 p1 \
   -- set Interface p1 type=dummy-pmd], [], [], [--dummy-numa="0,0,0,0,1,1,1,1"])

AT_SKIP_IF([! ovs-appctl dpif-netdev/miniflow-parser-get | sed 1,4d | grep "True"], [], [dnl
])

AT_CHECK([ovs-appctl dpif-netdev/dpif-impl-set dpif_avx512], [0], [dnl
DPIF implementation set to dpif_avx512.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set autovalidator], [0], [dnl
Miniflow extract implementation set to autovalidator.
])

cat packets | while read line; do
  AT_CHECK([ovs-appctl netdev-dummy/receive p1 $line], [0], [ignore])
done

OVS_WAIT_UNTIL([test `ovs-vsctl get interface p1 statistics | grep -oP 'rx_packets=\s*\K\d+'` -ge 16000])

OVS_VSWITCHD_STOP(["dnl
/upcall: datapath reached the dynamic limit of .* flows./d"])
AT_CLEANUP

AT_SETUP([dpif-netdev - MFEX Configuration])
OVS_VSWITCHD_START(
  [set Open_vSwitch . other_config:pmd-cpu-mask=0x1 \
   -- add-port br0 p1 \
   -- set Interface p1 type=dummy-pmd], [], [], [--dummy-numa="0,0,0,0,1,1,1,1"])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set scalar 1], [2],
[], [dnl
Error: unknown argument 1.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 6 study 300 xyz], [2],
[], [dnl
Error: invalid study_pkt_cnt value: xyz.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set scalar abcd], [2],
[], [dnl
Error: unknown argument abcd.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 0 scalar abcd], [2],
[], [dnl
Error: unknown argument abcd.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd], [2],
[], [dnl
Error: -pmd option requires a thread id argument.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set tudy abcd], [2],
[], [dnl
Error: unknown argument abcd.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 7 study abcd], [2],
[], [dnl
Error: invalid study_pkt_cnt value: abcd.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 0 study], [0], [dnl
Miniflow extract implementation set to study, on pmd thread 0, studying 128 packets.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 0 study 512], [0], [dnl
Miniflow extract implementation set to study, on pmd thread 0, studying 512 packets.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set study 512], [0], [dnl
Miniflow extract implementation set to study, studying 512 packets.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set study], [0], [dnl
Miniflow extract implementation set to study, studying 128 packets.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 0 autovalidator], [0], [dnl
Miniflow extract implementation set to autovalidator, on pmd thread 0.
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd zero study], [2],
[], [dnl
Error: miniflow extract parser not changed, PMD thread passed is not valid: 'zero'. Pass a valid pmd thread ID.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 1], [2],
[], [dnl
Error: no miniflow extract name provided. Output of miniflow-parser-get shows implementation list.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 1 superstudy], [2],
[], [dnl
Error: unknown miniflow extract implementation superstudy.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set superstudy], [2],
[], [dnl
Error: unknown miniflow extract implementation superstudy.
ovs-appctl: ovs-vswitchd: server returned an error
])

AT_CHECK([ovs-appctl dpif-netdev/miniflow-parser-set -pmd 1 study -pmd], [2],
[], [dnl
Error: invalid study_pkt_cnt value: -pmd.
ovs-appctl: ovs-vswitchd: server returned an error
])

OVS_VSWITCHD_STOP(["dnl
/Error: unknown argument 1./d
/Error: invalid study_pkt_cnt value: xyz./d
/Error: unknown argument abcd./d
/Error: -pmd option requires a thread id argument./d
/Error: invalid study_pkt_cnt value: abcd./d
/Error: miniflow extract parser not changed, PMD thread passed is not valid: 'zero'. Pass a valid pmd thread ID./d
/Error: no miniflow extract name provided. Output of miniflow-parser-get shows implementation list./d
/Error: unknown miniflow extract implementation superstudy./d
/Error: invalid study_pkt_cnt value: -pmd./d"])
AT_CLEANUP

AT_SETUP([datapath - Actions Autovalidator Checksum])

OVS_VSWITCHD_START(add-port br0 p0 -- set Interface p0 type=dummy \
                   -- add-port br0 p1 -- set Interface p1 type=dummy)

AT_CHECK([ovs-appctl odp-execute/action-impl-set autovalidator], [0], [dnl
Action implementation set to autovalidator.
])

dnl Add flows to trigger checksum calculation.
AT_DATA([flows.txt], [dnl
  in_port=p0,ip,actions=mod_nw_src=10.1.1.1,p1
  in_port=p0,ipv6,actions=set_field:fc00::100->ipv6_src,p1
])
AT_CHECK([ovs-ofctl del-flows br0])
AT_CHECK([ovs-ofctl -Oopenflow13 add-flows br0 flows.txt])

dnl Make sure checksum won't be offloaded.
AT_CHECK([ovs-vsctl set Interface p0 options:ol_ip_csum=false])
AT_CHECK([ovs-vsctl set Interface p0 options:ol_ip_csum_set_good=false])

AT_CHECK([ovs-vsctl set Interface p1 options:pcap=p1.pcap])

dnl IPv4 packet with values that will trigger carry-over addition for checksum.
flow_s_v4="
  eth_src=47:42:86:08:17:50,eth_dst=3e:55:b5:9e:3a:fb,dl_type=0x0800,
  nw_src=229.167.36.90,nw_dst=130.161.64.186,nw_proto=6,nw_ttl=64,nw_frag=no,
  tp_src=54392,tp_dst=5201,tcp_flags=ack"

good_frame=$(ovs-ofctl compose-packet --bare "${flow_s_v4}")
AT_CHECK([ovs-appctl netdev-dummy/receive p0 ${good_frame}])

dnl Checksum should change to 0xAC33 with ip_src changed to 10.1.1.1
dnl by the datapath while processing the packet.
flow_expected=$(echo "${flow_s_v4}" | sed 's/229.167.36.90/10.1.1.1/g')
good_expected=$(ovs-ofctl compose-packet --bare "${flow_expected}")
AT_CHECK([ovs-pcap p1.pcap > p1.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p1.pcap.txt], [0], [${good_expected}
])

dnl Repeat similar test for IPv6.
flow_s_v6="
  eth_src=8a:bf:7e:2f:05:84,eth_dst=0a:8f:39:4f:e0:73,dl_type=0x86dd,
  ipv6_src=2f8a:2076:3926:9e7:2d47:4bc9:9c7:17f3,
  ipv6_dst=7287:10dd:2fb9:41d5:3eb2:2c7a:11b0:6258,
  ipv6_label=0x51ac,nw_proto=6,nw_ttl=142,nw_frag=no,
  tp_src=20405,tp_dst=20662,tcp_flags=ack"

good_frame_v6=$(ovs-ofctl compose-packet --bare "${flow_s_v6}")
AT_CHECK([ovs-appctl netdev-dummy/receive p0 ${good_frame_v6}])

dnl Checksum should change to 0x59FD with ipv6_src changed to fc00::100
dnl by the datapath while processing the packet.
flow_expected_v6=$(echo "${flow_s_v6}" | \
  sed 's/2f8a:2076:3926:9e7:2d47:4bc9:9c7:17f3/fc00::100/g')
good_expected_v6=$(ovs-ofctl compose-packet --bare "${flow_expected_v6}")
AT_CHECK([ovs-pcap p1.pcap > p1.pcap.txt 2>&1])
AT_CHECK_UNQUOTED([tail -n 1 p1.pcap.txt], [0], [${good_expected_v6}
])

OVS_VSWITCHD_STOP
AT_CLEANUP
