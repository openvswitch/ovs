AT_COPYRIGHT([Copyright (c) 2025 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.])

AT_BANNER([dpdk's rte_flow offload unit tests])

AT_SETUP([dpdk offload - ping between two hardware offloaded ports])
OVS_DPDK_OFFLOAD_PRE_CHECK()
OVS_TRAFFIC_VSWITCHD_START()

AT_CHECK([ovs-ofctl add-flow br0 "actions=normal"])
ADD_NAMESPACES(at_ns0, at_ns1)
ADD_VF(p0, at_ns0, br0, "10.1.1.1/24")
ADD_VF(p1, at_ns1, br0, "10.1.1.2/24")

NS_CHECK_EXEC([at_ns0], [ping -q -c 3 -i 0.3 -W 2 10.1.1.2 \
                         | FORMAT_PING], [0], [dnl
3 packets transmitted, 3 received, 0% packet loss, time 0ms
])

OVS_WAIT_UNTIL_EQUAL(
  [ovs-appctl dpctl/dump-flows --names type=dpdk,offloaded \
   | DUMP_DP_IP_CLEAN_SORTED], [dnl
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0])

OVS_TRAFFIC_VSWITCHD_STOP
AT_CLEANUP

m4_define([DPDK_OFFLOAD_SIX_PORT_PING_TEST], [dnl
  AT_SETUP($1)
  OVS_DPDK_OFFLOAD_PRE_CHECK()
  OVS_TRAFFIC_VSWITCHD_START($2)
  m4_ifval([$2], [CHECK_CPU_DISCOVERED([14])])

  AT_CHECK([ovs-ofctl add-flow br0 "actions=normal"])
  AT_CHECK([ovs-vsctl set Open_vSwitch . other_config:max-idle=20000])
  ADD_NAMESPACES(at_ns0, at_ns1, at_ns2, at_ns3, at_ns4, at_ns5)
  ADD_VF(p0, at_ns0, br0, "10.1.1.1/24")
  ADD_VF(p1, at_ns1, br0, "10.1.1.2/24")
  ADD_VF(p2, at_ns2, br0, "10.1.1.3/24")
  ADD_VF(p3, at_ns3, br0, "10.1.1.4/24")
  ADD_VF(p4, at_ns4, br0, "10.1.1.5/24")
  ADD_VF(p5, at_ns5, br0, "10.1.1.6/24")

  for NS in $(seq 0 5); do
      START=$((NS + 2))
      for IP in $(seq "$START" 6); do
          NS_CHECK_EXEC([at_ns$NS], [ping -q -c 3 -i 0.3 -W 2 10.1.1.$IP \
                                     | FORMAT_PING], [0], [dnl
3 packets transmitted, 3 received, 0% packet loss, time 0ms
])
      done
  done

  OVS_WAIT_UNTIL_EQUAL(
    [ovs-appctl dpctl/dump-flows --names type=dpdk,offloaded \
     | DUMP_DP_IP_CLEAN_SORTED], [dnl
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p2
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p3
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p4
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p5
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p2
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p3
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p4
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p5
in_port(ovs-p2),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0
in_port(ovs-p2),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p2),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p3
in_port(ovs-p2),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p4
in_port(ovs-p2),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p5
in_port(ovs-p3),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0
in_port(ovs-p3),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p3),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p2
in_port(ovs-p3),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p4
in_port(ovs-p3),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p5
in_port(ovs-p4),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0
in_port(ovs-p4),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p4),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p2
in_port(ovs-p4),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p3
in_port(ovs-p4),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p5
in_port(ovs-p5),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p0
in_port(ovs-p5),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p1
in_port(ovs-p5),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p2
in_port(ovs-p5),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p3
in_port(ovs-p5),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:2, bytes:196, used:0.0s, actions:ovs-p4])

  AT_CHECK([ovs-appctl dpctl/offload-stats-show], [0], [ignore], [ignore])
  AT_CHECK([ovs-appctl dpif-netdev/pmd-rxq-show], [0], [ignore], [ignore])

  OVS_TRAFFIC_VSWITCHD_STOP
  AT_CLEANUP
])

DPDK_OFFLOAD_SIX_PORT_PING_TEST(
    [dpdk offload - ping between six hardware offloaded ports])

DPDK_OFFLOAD_SIX_PORT_PING_TEST(
    [dpdk offload - ping with multiple offload threads],
    [-- set Open_vSwitch . other_config:pmd-cpu-mask=0x3ffc \
     -- set Open_vSwitch . other_config:n-offload-threads=10])

AT_SETUP([dpdk offload - partial offload])
OVS_DPDK_OFFLOAD_PRE_CHECK()
OVS_TRAFFIC_VSWITCHD_START()

ADD_NAMESPACES(at_ns1, at_ns2, at_ns3, at_ns4)

ADD_VETH(p1, at_ns1, br0, "10.1.1.1/24")
ADD_VETH(p2, at_ns2, br0, "10.1.1.2/24")
ADD_VETH(p3, at_ns3, br0, "10.1.1.3/24")
ADD_VETH(p4, at_ns4, br0, "10.1.1.4/24")

AT_DATA([flows.txt], [dnl
table=0,ipv6, actions=drop
table=0,in_port=2 actions=output:1
table=0,in_port=1 actions=load:0x1->NXM_NX_REG1[[]],resubmit(,1),load:0x2->NXM_NX_REG1[[]],resubmit(,1)
table=1,in_port=1,reg1=0x1 actions=check_pkt_larger(200)->NXM_NX_REG0[[0]],resubmit(,4)
table=1,in_port=1,reg1=0x2 actions=output:2
table=4,in_port=1,reg0=0x1 actions=output:3
table=4,in_port=1,reg0=0x0 actions=output:4
])
AT_CHECK([ovs-ofctl --protocols=OpenFlow10 add-flows br0 flows.txt])

NS_CHECK_EXEC([at_ns1], [ping -q -c 10 -i 0.1 -W 2 -s 64 10.1.1.2 \
                         | FORMAT_PING], [0], [dnl
10 packets transmitted, 10 received, 0% packet loss, time 0ms
], [], [ovs-appctl dpctl/dump-flows; ovs-ofctl dump-flows br0])

AT_CHECK([ovs-appctl dpctl/dump-flows type=dpdk,partially-offloaded \
          | grep "check_pkt_len" | DUMP_DP_IP_CLEAN_SORTED], [0], [dnl
in_port(2),eth_type(0x0800),ipv4(frag=no), packets:9, bytes:954, used:0.0s, actions:check_pkt_len(size=200,gt(4),le(5)),3
])

AT_CHECK([test $(ovs-appctl dpif-netdev/pmd-stats-show | \
                 awk '/phwol hits:/ {sum += $3} END {print sum}') -ge 8])

OVS_TRAFFIC_VSWITCHD_STOP
AT_CLEANUP

AT_SETUP([dpdk offload - flow modification non-offload -> offload])
OVS_DPDK_OFFLOAD_PRE_CHECK()
OVS_TRAFFIC_VSWITCHD_START()

ADD_NAMESPACES(at_ns0, at_ns1, at_ns2)
ADD_VF(p0, at_ns0, br0, "10.1.1.1/24")
ADD_VF(p1, at_ns1, br0, "10.1.1.2/24")
ADD_VF(p2, at_ns2, br0, "10.1.1.3/24")

NS_CHECK_EXEC([at_ns0], [sysctl -w net.ipv6.conf.all.disable_ipv6=1], [0],
              [ignore])
NS_CHECK_EXEC([at_ns1], [sysctl -w net.ipv6.conf.all.disable_ipv6=1], [0],
              [ignore])
NS_CHECK_EXEC([at_ns2], [sysctl -w net.ipv6.conf.all.disable_ipv6=1], [0],
              [ignore])

AT_CHECK([ovs-ofctl add-flow br0 "actions=normal"])

m4_define([ICMP_PKT], [m4_join([,],
  [eth_src=f0:00:00:01:01:01,eth_dst=f0:00:00:01:01:02,eth_type=0x0800],
  [nw_src=10.1.1.1,nw_dst=10.1.1.2],
  [nw_proto=1,nw_ttl=64,nw_frag=no],
  [icmp_type=8,icmp_code=0])])

m4_define([ICMP_PKT_REPLY], [m4_join([,],
  [eth_src=f0:00:00:01:01:02,eth_dst=f0:00:00:01:01:01,eth_type=0x0800],
  [nw_src=10.1.1.2,nw_dst=10.1.1.1],
  [nw_proto=1,nw_ttl=64,nw_frag=no],
  [icmp_type=8,icmp_code=0])])

# Send a packet in one direction; this should create a non-offloadable
# flow between br0 and ovs-p1.
NS_CHECK_EXEC([at_ns0], [$PYTHON3 $srcdir/sendpkt.py p0 \
    $(ovs-ofctl compose-packet --bare 'ICMP_PKT' '')], [0], [ignore])

OVS_WAIT_UNTIL_EQUAL(
  [ovs-appctl dpctl/dump-flows --names type=partially-offloaded \
   | grep "f0:00:00:01:01:01" | DUMP_DP_IP_CLEAN_SORTED], [dnl
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:0, bytes:0, used:never, actions:br0,ovs-p1,ovs-p2])

# Send the reply packet. A new flow should be inserted in hardware for the
# reverse direction (since the FDB entry for the destination is known).
# However, the revalidator should update the originating flow, causing it to
# be fully offloaded.
NS_CHECK_EXEC([at_ns1], [$PYTHON3 $srcdir/sendpkt.py p1 \
    $(ovs-ofctl compose-packet --bare 'ICMP_PKT_REPLY' '')], [0], [ignore])

OVS_WAIT_UNTIL_EQUAL(
  [ovs-appctl dpctl/dump-flows --names type=dpdk,offloaded \
   | grep "f0:00:00:01:01:01" | DUMP_DP_IP_CLEAN_SORTED], [dnl
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:0, bytes:0, used:never, actions:ovs-p1
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:0, bytes:0, used:never, actions:ovs-p0])

# Send 50 packets in each direction, and verify the packets are handled by
# the hardware rather than by the PMDs.
NS_CHECK_EXEC([at_ns0], [$PYTHON3 $srcdir/sendpkt.py -c 50 p0 \
    $(ovs-ofctl compose-packet --bare 'ICMP_PKT' '')], [0], [ignore])
NS_CHECK_EXEC([at_ns1], [$PYTHON3 $srcdir/sendpkt.py -c 50 p1 \
    $(ovs-ofctl compose-packet --bare 'ICMP_PKT_REPLY' '')], [0], [ignore])

OVS_WAIT_UNTIL_EQUAL(
  [ovs-appctl dpctl/dump-flows --names type=dpdk,offloaded \
   | grep "f0:00:00:01:01:01" | DUMP_DP_IP_CLEAN_SORTED], [dnl
in_port(ovs-p0),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:50, bytes:3000, used:0.0s, actions:ovs-p1
in_port(ovs-p1),eth(macs),eth_type(0x0800),ipv4(frag=no), packets:50, bytes:3000, used:0.0s, actions:ovs-p0])

AT_CHECK([test $(ovs-appctl dpif-netdev/pmd-stats-show | \
              awk '/packets received:/ {sum += $3} END {print sum}') -lt 10])

OVS_TRAFFIC_VSWITCHD_STOP
AT_CLEANUP
